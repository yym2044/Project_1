<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yym.infra.modules.member.MemberMpp">

	<resultMap id="resultMapObj"
		type="com.yym.infra.modules.member.Member"></resultMap>

	<sql id="selectListCommon">
		FROM infrMember a
		LEFT JOIN infrMemberEmail b ON b.ifmmSeq = a.ifmmSeq AND ifmeDefaultNy = 1
		WHERE ifmmDelNy = 0
		
		<choose>
			<when test="shIfscSeq == 1">AND ifmmName like concat('%',#{searchBar},'%')</when>
			<when test="shIfscSeq == 2">AND ifmmId like concat('%',#{searchBar},'%')</when>
			<when test="shIfscSeq == 3">AND b.ifmeEmailFull LIKE concat('%',#{searchBar},'%')</when>
		</choose>
		
		<!-- 	체크를 여러개 해도 하나만 선택되는 결과를 보여준다.
		<choose>
			<when test="shIfmmEmailConsentNy == 1">AND ifmmEmailConsentNy = 1</when>
			<when test="shIfmmSmsConsentNy == 1">AND ifmmSmsConsentNy = 1</when>
			<when test="shIfmmPushConsentNy == 1">AND ifmmPushConsentNy = 1</when>
		</choose>		
		 -->
		 
		<if test="shIfmmEmailConsentNy == 1">
			AND ifmmEmailConsentNy = 1
		</if>
		<if test="shIfmmSmsConsentNy == 1">
			AND ifmmSmsConsentNy = 1
		</if>
		<if test="shIfmmPushConsentNy == 1">
			AND ifmmPushConsentNy = 1
		</if>
		
		<choose>
			<when test="shIfmmGrade == 1">AND 1=1</when>
			<when test="shIfmmGrade == 2">AND ifmmGradeCd = 76</when>
			<when test="shIfmmGrade == 3">AND ifmmGradeCd = 77</when>
		</choose>
		
		
		
		<if test="shIfmmId != null and !shIfmmId.equals('')">
			AND ifmmId LIKE concat('%',#{shIfmmId},'%')
		</if>
		
		 <choose>
		 	<when test="sort == 'sortNo' and orderby == 'top'">
				ORDER BY
					ifmmSeq
		 	</when>
		 	<when test="sort == 'sortNo' and orderby == 'bottom'">
				ORDER BY
					ifmmSeq desc
		 	</when>
		 	<when test="sort == 'sortId' and orderby == 'top'">
				ORDER BY
					ifmmId
		 	</when>
		 	<when test="sort == 'sortId' and orderby == 'bottom'">
				ORDER BY
					ifmmId desc
		 	</when>
		 	<when test="sort == 'sortName' and orderby == 'top'">
				ORDER BY
					ifmmName
		 	</when>
		 	<when test="sort == 'sortName' and orderby == 'bottom'">
				ORDER BY
					ifmmName desc
		 	</when>
		 	<when test="sort == 'sortGrade' and orderby == 'top'">
				ORDER BY
					ifmmGradeCd
		 	</when>
		 	<when test="sort == 'sortGrade' and orderby == 'bottom'">
				ORDER BY
					ifmmGradeCd desc
		 	</when>
		 	<when test="sort == 'sortRedt' and orderby == 'top'">
				ORDER BY
					ifmmRegDate
		 	</when>
		 	<when test="sort == 'sortRedt' and orderby == 'bottom'">
				ORDER BY
					ifmmRegDate desc
		 	</when>
		 </choose>
	</sql>

	<select id="selectListCount" resultType="Integer">
		SELECT
			count(*)
		<include refid="selectListCommon"/>
	</select>

	<select id="selectList" resultMap="resultMapObj">
		SELECT
			a.ifmmSeq
			, a.ifmmName
			, a.ifmmId
			, (select ifcdName from infrCode where ifcdSeq = a.ifmmGenderCd) as ifmmGenderName
			, a.ifmmDob
			, a.ifmmFavoriteColor
			, a.ifmmDelNy
			, (select ifcdName from infrCode where ifcdSeq = a.ifmmGradeCd) as ifmmGrade
			, a.ifmmRegDate
			, (select ifcdName from infrCode where ifcdSeq = a.ifmmStatusCd) as ifmmStatus
			, b.ifmeEmailFull
		 <include refid="selectListCommon"/>
		 LIMIT #{startRnumForMysql}, #{rowNumToShow}
	</select>
	
	<select id="selectListAllMember" resultMap="resultMapObj">
		SELECT
			ifmmSeq
		FROM
			infrMember
	</select>

	
	<select id="selectListSearch" resultMap="resultMapObj">
	SELECT
		ifscSeq
		, ifscName
	FROM
		infrSearch
	</select>
	
	<select id="selectListCode" resultMap="resultMapObj">
	SELECT 
		ifcdSeq
		,ifcdName
	FROM 
		infrCode a
	LEFT JOIN infrCodeGroup b on b.ifcgSeq = a.ifcgSeq
	WHERE ifcgName LIKE "%등급%"
	</select>

	<select id="selectOne" resultMap="resultMapObj">
		SELECT DISTINCT
			a.ifmmSeq
			, a.ifmmName
			, a.ifmmId
			, a.ifmmPwd
			, (select ifcdName from infrCode where ifcdSeq = a.ifmmGenderCd) as ifmmGenderName
			, a.ifmmDob
			, a.ifmmFavoriteColor
			, a.ifmmDelNy
			, (select ifcdName from infrCode where ifcdSeq = a.ifmmGradeCd) as ifmmGrade
			, a.ifmmRegDate
			, (select ifcdName from infrCode where ifcdSeq = a.ifmmStatusCd) as ifmmStatus
			, if(a.ifmmEmailConsentNy=1,'수신동의','수신거부') as ifmmEmailConsentNyText
			, if(a.ifmmSmsConsentNy=1,'수신동의','수신거부') as ifmmSmsConsentNyText
			, if(a.ifmmPushConsentNy=1,'수신동의','수신거부') as ifmmPushConsentNyText
						
			, b.ifmeEmailFull
			
			, (select ifmpNumber from infrMemberPhone where ifmpDeviceCd = 26 and ifmmSeq = #{ifmmSeq}) as ifmpNumberMobile
			, (select ifmpNumber from infrMemberPhone where ifmpDeviceCd = 25 and  ifmmSeq = #{ifmmSeq}) as ifmpNumberHome
			
			, d.ifmaZipCode
			, d.ifmaAddress1
			, d.ifmaAddress2
			
		FROM infrMember a
		LEFT JOIN infrMemberEmail b ON b.ifmmSeq = a.ifmmSeq AND b.ifmeDefaultNy = 1
		LEFT JOIN infrMemberPhone c ON c.ifmmSeq = a.ifmmSeq
		LEFT JOIN infrMemberAddress d ON d.ifmmSeq = a.ifmmSeq AND d.ifmaDefaultNy = 1
		WHERE
			1=1
		AND a.ifmmSeq = #{ifmmSeq}
	</select>
	
	<!-- INSERT -->
	
	<insert id="insertMember">
	INSERT INTO
	infrMember (
		ifmmSeq
		, ifmmName
		, ifmmId
		, ifmmPwd
		, ifmmGenderCd
		, ifmmDob
		, ifmmDelNy
		, ifmmGradeCd
		, ifmmRegDate
		, ifmmStatusCd
		, ifmmEmailConsentNy
		, ifmmSmsConsentNy
		, ifmmPushConsentNy
	) VALUES (
		#{ifmmSeq}
		, #{ifmmName}
		, #{ifmmId}
		, #{ifmmPwd}
		, #{ifmmGenderCd}
		, #{ifmmDob}
		, 0
		, #{ifmmGradeCd}
		, curdate()
		, 78
		, #{ifmmEmailConsentNy}
		, #{ifmmSmsConsentNy}
		, #{ifmmPushConsentNy}
	);
			
	</insert>
	<insert id="insertMemberEmail">
	INSERT INTO
	infrMemberEmail (
		ifmmSeq
		, ifmeEmailFull
		, ifmeDefaultNy
	) VALUES (
		#{ifmmSeq}
		, #{ifmeEmailFull}
		, 1
	)
	</insert>
	<insert id="insertMemberAddress">
	INSERT INTO
	infrMemberAddress (
		ifmmSeq
		, ifmaZipCode
		, ifmaAddress1
		, ifmaAddress2
        , ifmaDefaultNy
	) VALUES (
		#{ifmmSeq}
		, #{ifmaZipCode}
		, #{ifmaAddress1}
		, #{ifmaAddress2}
        , 1
	);
	</insert>
	
	<insert id="insertMemberPhoneMobile">
	INSERT INTO
	infrMemberPhone (
		ifmmSeq
        , ifmpNumber
        , ifmpDeviceCd
        , ifmpDefaultNy
    ) VALUES (
		#{ifmmSeq}				
        , #{ifmpNumberMobile}		
        , 26
        , 1
    )
	</insert>
	<insert id="insertMemberPhoneHome">
	INSERT INTO
	infrMemberPhone (
		ifmmSeq
        , ifmpNumber
        , ifmpDeviceCd
        , ifmpDefaultNy
    ) VALUES (
		#{ifmmSeq}
        , #{ifmpNumberHome}		
        , 25
        , 1
    )
	</insert>
	
	
	
	<!-- UPDATE -->
	
	<update id="updateMember">
	UPDATE infrMember
	SET
		ifmmName = #{ifmmName}
		, ifmmId = #{ifmmId}
		, ifmmPwd = #{ifmmPwd}
		, ifmmGenderCd = #{ifmmGenderCd}
		, ifmmDob = #{ifmmDob}
		, ifmmDelNy = 0
		, ifmmGradeCd = #{ifmmGradeCd}
		, ifmmStatusCd = 78
		, ifmmEmailConsentNy = #{ifmmEmailConsentNy}
		, ifmmSmsConsentNy = #{ifmmSmsConsentNy}
		, ifmmPushConsentNy = #{ifmmPushConsentNy}
	WHERE
		1 = 1
	AND
		ifmmSeq = #{ifmmSeq}
	</update>
	<update id="updateMemberEmail">
	UPDATE infrMemberEmail
	SET
		ifmeEmailFull = #{ifmeEmailFull}
		, ifmeDefaultNy = 1
	WHERE
		1 = 1
	AND
		ifmmSeq = #{ifmmSeq}
	</update>
	<update id="updateMemberAddress">
	UPDATE infrMemberAddress
	SET
		ifmaZipCode = #{ifmaZipCode}
		, ifmaAddress1 = #{ifmaAddress1}
		, ifmaAddress2 = #{ifmaAddress2}
		, ifmaDefaultNy = 1
	WHERE
		1 = 1
	AND
		ifmmSeq = #{ifmmSeq}
	</update>
	
	<update id="updateMemberPhoneMobile">
	UPDATE infrMemberPhone
	SET
		ifmpNumber = #{ifmpNumberMobile}
		, ifmpDeviceCd = 26
		, ifmpDefaultNy = 1
	WHERE
		1 = 1
	AND
		ifmmSeq = #{ifmmSeq}
	AND
		ifmpDeviceCd = 26
	</update>
	<update id="updateMemberPhoneHome">
	UPDATE infrMemberPhone
	SET
		ifmpNumber = #{ifmpNumberHome}
		, ifmpDeviceCd = 25
		, ifmpDefaultNy = 1
	WHERE
		1 = 1
	AND
		ifmmSeq = #{ifmmSeq}
	AND
		ifmpDeviceCd = 25	
	</update>
	
	<!-- 
	<delete id="deleteMember">
	DELETE FROM
		infrMember
	WHERE 1=1
		AND ifmmSeq = #{ifmmSeq}
	</delete>
	<delete id="deleteMemberEmail">
	DELETE FROM
		infrMemberEmail
	WHERE 1=1
		AND ifmmSeq = #{ifmmSeq}
	</delete>
	<delete id="deleteMemberAddress">
	DELETE FROM
		infrMemberAddress
	WHERE 1=1
		AND ifmmSeq = #{ifmmSeq}
	</delete>
	<delete id="deleteMemberPhone">
	DELETE FROM
		infrMemberPhone
	WHERE 1=1
		AND ifmmSeq = #{ifmmSeq}
	</delete>
	 -->
	 
	 
	 <update id="updateMemberDelNy">
	 
	 UPDATE
	 	infrMember
 	 SET
 	 	ifmmDelNy = 1
 	 WHERE
 	 	1=1
		AND ifmmSeq = #{checkbox1}
	 
	 </update>
	 
</mapper>